name: Cleanup GHCR (Manual Only)

on:
  workflow_dispatch:
    inputs:
      execute_delete:
        description: "true = delete / false = preview only"
        required: true
        default: "false"

permissions:
  packages: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # ==========================================================
      # ğŸ” PREVIEW (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
      # ==========================================================
      - name: Preview package versions
        if: github.event.inputs.execute_delete != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "========================================"
          echo "GHCR VERSION PREVIEW (NO DELETE)"
          echo "========================================"

          echo ""
          echo "---- ALL VERSIONS ----"
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | {id: .id, tags: .metadata.container.tags}'

          echo ""
          echo "---- UNTAGGED (will be deleted) ----"
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | select(.metadata.container.tags | length == 0) | {id: .id}'

          echo ""
          echo "---- dev-rstudio ----"
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | select(.metadata.container.tags[]? == "dev-rstudio") | {id: .id}'

          echo ""
          echo "---- dev-ssh ----"
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | select(.metadata.container.tags[]? == "dev-ssh") | {id: .id}'

      # ==========================================================
      # ğŸ—‘ DELETEï¼ˆæ˜ç¤ºæŒ‡å®šæ™‚ã®ã¿ï¼‰
      # ==========================================================
      - name: Delete untagged images
        if: github.event.inputs.execute_delete == 'true'
        uses: actions/delete-package-versions@v5
        with:
          package-name: rstudio_docker
          package-type: container
          delete-only-untagged-versions: true

      - name: Cleanup old dev-rstudio
        if: github.event.inputs.execute_delete == 'true'
        uses: actions/delete-package-versions@v5
        with:
          package-name: rstudio_docker
          package-type: container
          delete-only-versions: '^dev-rstudio$'
          min-versions-to-keep: 1

      - name: Cleanup old dev-ssh
        if: github.event.inputs.execute_delete == 'true'
        uses: actions/delete-package-versions@v5
        with:
          package-name: rstudio_docker
          package-type: container
          delete-only-versions: '^dev-ssh$'
          min-versions-to-keep: 1
