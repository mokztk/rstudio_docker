name: Cleanup GHCR (ID Safe)

on:
  workflow_dispatch:
    inputs:
      execute_delete:
        description: "true = delete / false = preview"
        required: true
        default: "false"

permissions:
  packages: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install gh + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # ==========================================================
      #  PREVIEW
      # ==========================================================
      - name: Preview versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "==== ALL VERSIONS ===="
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | {id: .id, tags: .metadata.container.tags}'

          echo "==== UNTAGGED (target) ===="
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | select(.metadata.container.tags | length == 0) | {id: .id}'

          echo "==== dev-rstudio ===="
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | select(.metadata.container.tags[]? == "dev-rstudio") | {id: .id}'

          echo "==== dev-ssh ===="
          gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq '.[] | select(.metadata.container.tags[]? == "dev-ssh") | {id: .id}'

      # ==========================================================
      #  COLLECT IDS (delete時のみ)
      # ==========================================================
      - name: Collect delete IDs
        id: collect
        if: github.event.inputs.execute_delete == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IDS=$(gh api \
            /users/${{ github.repository_owner }}/packages/container/rstudio_docker/versions \
            --paginate \
            | jq -r '.[] | select(.metadata.container.tags | length == 0) | .id' \
            | paste -sd "," -)

          echo "IDS=$IDS" >> $GITHUB_OUTPUT

          echo "Delete target IDs:"
          echo "$IDS"

      # ==========================================================
      #  DELETE (明示指定時のみ)
      # ==========================================================
      - name: Delete package versions
        if: github.event.inputs.execute_delete == 'true'
        uses: actions/delete-package-versions@v5
        with:
          package-name: rstudio_docker
          package-type: container
          package-version-ids: ${{ steps.collect.outputs.IDS }}
